// ==UserScript==
// @name         æŠ–éŸ³ä¿¡æ¯æå–å™¨ï¼ˆè‡ªåŠ¨è·å–ä¼˜åŒ–ç‰ˆ v10.1ï¼‰
// @namespace    https://github.com/kevencs/Douyin-User-Info-Extractor
// @version      10.1
// @description  æ™ºèƒ½è¯†åˆ«æŠ–éŸ³ä¸»é¡µç±»å‹ï¼Œè‡ªåŠ¨æå–å¹¶å±•ç¤ºåšä¸»åå­—ã€SecUIDã€UIDã€SecUserIDä¸Cookieä¿¡æ¯ï¼Œå¹¶æä¾›ä¸€é”®å¤åˆ¶åŠŸèƒ½
// @author       kevencs
// @license      MIT
// @homepageURL  https://github.com/kevencs
// @supportURL   https://github.com/kevencs
// @match        *://*.douyin.com/*
// @match        *://douyin.com/*
// @grant        GM_setClipboard
// @grant        GM_notification
// @grant        GM_addStyle
// @run-at       document-start
// ==/UserScript==

/*
æœ¬æ’ä»¶æœ‰éƒ¨åˆ†çµæ„Ÿä¸åŠŸèƒ½æ¥æºäºæŠ–å°äº‘ä½œè€…çš„ä¼˜ç§€ç¨‹åºï¼Œåœ¨æ­¤è¡¨ç¤ºè¯šæŒšæ„Ÿè°¢ã€‚
*/

(function() {
    'use strict';

    // é…ç½®ä¿¡æ¯
    const CONFIG = {
        themes: {
            others: {
                primary: '#FF2D55',
                secondary: '#FF6B9D',
                accent: '#FF9500',
                background: 'linear-gradient(135deg, #fff5f7 0%, #ffffff 100%)',
                cardBg: 'rgba(255, 255, 255, 0.95)',
                textPrimary: '#2c3e50',
                textSecondary: '#7f8c8d'
            },
            self: {
                primary: '#8A2BE2',
                secondary: '#9B59B6',
                accent: '#3498DB',
                background: 'linear-gradient(135deg, #f8f5ff 0%, #ffffff 100%)',
                cardBg: 'rgba(255, 255, 255, 0.95)',
                textPrimary: '#2c3e50',
                textSecondary: '#7f8c8d'
            }
        }
    };

    // æ–°å¢ï¼šæ ‡è®°æ˜¯å¦å·²å°è¯•è‡ªåŠ¨ç‚¹å‡»
    let autoClickAttempted = false;

    // ç”¨æˆ·æ•°æ®å­˜å‚¨
    let userData = {
        nickname: '',
        uid: '',
        secUid: '',
        isOwnPage: null,
        lastUpdated: '',
        cookies: '',
        hasAutoTriggered: false
    };

    // æ·»åŠ å…¨å±€æ ·å¼
    GM_addStyle(`
        :root {
            --primary-color: #FF2D55;
            --secondary-color: #FF6B9D;
            --accent-color: #FF9500;
            --background-color: linear-gradient(135deg, #fff5f7 0%, #ffffff 100%);
            --card-bg-color: rgba(255, 255, 255, 0.95);
            --text-primary-color: #2c3e50;
            --text-secondary-color: #7f8c8d;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        #dy-extractor-trigger {
            position: fixed !important;
            bottom: 25px !important;
            right: 20px !important;
            width: 52px !important;
            height: 52px !important;
            border-radius: 26px !important;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
            color: white !important;
            border: none !important;
            font-size: 24px !important;
            cursor: pointer !important;
            z-index: 2147483647 !important;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15) !important;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            opacity: 0.15 !important;
            backdrop-filter: blur(8px) !important;
            border: 2px solid rgba(255,255,255,0.7) !important;
        }

        #dy-extractor-trigger:hover {
            opacity: 1 !important;
            transform: translateY(-5px) scale(1.08) rotate(5deg) !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.2), 0 0 0 3px rgba(255,255,255,0.3) !important;
        }

        /* ä¸»é¢æ¿ */
        #dy-extractor-panel {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(0.95) !important;
            width: 420px !important;
            max-height: 75vh !important;
            background: var(--background-color) !important;
            border-radius: 22px !important;
            box-shadow: 0 25px 70px rgba(0,0,0,0.18) !important;
            z-index: 2147483646 !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
            overflow: hidden !important;
            display: none !important;
            opacity: 0 !important;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
            border: 1px solid rgba(255,255,255,0.4) !important;
        }

        #dy-extractor-panel.show {
            transform: translate(-50%, -50%) scale(1) !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* é¢æ¿é®ç½© */
        #dy-extractor-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0,0,0,0.35) !important;
            backdrop-filter: blur(3px) !important;
            z-index: 2147483645 !important;
            display: none !important;
            opacity: 0 !important;
            transition: opacity 0.3s ease !important;
        }

        #dy-extractor-overlay.show {
            display: block !important;
            opacity: 1 !important;
        }

        /* é¢æ¿å¤´éƒ¨ */
        .dy-extractor-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
            color: white !important;
            padding: 26px 28px !important;
            position: relative !important;
        }

        .dy-extractor-title {
            font-size: 20px !important;
            font-weight: 700 !important;
            margin: 0 0 10px 0 !important;
            display: flex !important;
            align-items: center !important;
            gap: 14px !important;
        }

        .dy-extractor-subtitle {
            font-size: 13px !important;
            opacity: 0.9 !important;
            margin: 0 !important;
            font-weight: 400 !important;
        }

        .dy-page-type-badge {
            background: rgba(255,255,255,0.22) !important;
            padding: 5px 14px !important;
            border-radius: 20px !important;
            font-size: 11px !important;
            font-weight: 700 !important;
            backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255,255,255,0.35) !important;
        }

        /* å…³é—­æŒ‰é’® */
        .dy-extractor-close {
            position: absolute !important;
            top: 22px !important;
            right: 22px !important;
            width: 30px !important;
            height: 30px !important;
            border-radius: 50% !important;
            background: rgba(255,255,255,0.22) !important;
            border: none !important;
            color: white !important;
            font-size: 18px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.3s ease !important;
            backdrop-filter: blur(8px) !important;
        }

        .dy-extractor-close:hover {
            background: rgba(255,255,255,0.35) !important;
            transform: rotate(90deg) scale(1.1) !important;
        }

        /* å†…å®¹åŒºåŸŸ */
        .dy-extractor-content {
            max-height: calc(75vh - 160px) !important;
            overflow-y: auto !important;
            padding: 24px !important;
        }

        .dy-extractor-content::-webkit-scrollbar {
            width: 5px !important;
        }

        .dy-extractor-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.04) !important;
            border-radius: 10px !important;
        }

        .dy-extractor-content::-webkit-scrollbar-thumb {
            background: var(--primary-color) !important;
            border-radius: 10px !important;
            opacity: 0.5 !important;
        }

        /* ä¿¡æ¯å¡ç‰‡ */
        .dy-info-card {
            background: var(--card-bg-color) !important;
            border-radius: 18px !important;
            padding: 22px !important;
            margin-bottom: 18px !important;
            border: 1px solid rgba(0,0,0,0.06) !important;
            transition: all 0.35s ease !important;
            position: relative !important;
            overflow: hidden !important;
            backdrop-filter: blur(10px) !important;
        }

        .dy-info-card:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 12px 35px rgba(0,0,0,0.1) !important;
        }

        .dy-info-card::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 5px !important;
            height: 100% !important;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color)) !important;
        }

        .dy-info-label {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            color: var(--text-secondary-color) !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            margin-bottom: 12px !important;
            text-transform: uppercase !important;
        }

        .dy-info-label-icon {
            font-size: 16px !important;
        }

        .dy-info-value-wrapper {
            display: flex !important;
            gap: 14px !important;
            align-items: flex-start !important;
        }

        .dy-info-value {
            flex: 1 !important;
            font-family: 'SF Mono', Monaco, Consolas, monospace !important;
            font-size: 14px !important;
            color: var(--text-primary-color) !important;
            word-break: break-all !important;
            padding: 14px !important;
            background: rgba(255,255,255,0.85) !important;
            border-radius: 14px !important;
            border: 1px solid rgba(0,0,0,0.08) !important;
            line-height: 1.5 !important;
            max-height: 140px !important;
            overflow-y: auto !important;
        }

        /* å¤åˆ¶æŒ‰é’® */
        .dy-copy-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
            color: white !important;
            border: none !important;
            border-radius: 14px !important;
            padding: 12px 20px !important;
            font-size: 13px !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            transition: all 0.3s !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            min-width: 100px !important;
            justify-content: center !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
        }

        .dy-copy-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 22px rgba(0,0,0,0.18) !important;
        }

        .dy-copy-btn.copied {
            background: linear-gradient(135deg, #10B981, #34D399) !important;
        }

        /* ä¸€é”®å¤åˆ¶æ‰€æœ‰æŒ‰é’® */
        .dy-copy-all-btn {
            background: linear-gradient(135deg, var(--accent-color), #FF5722) !important;
            color: white !important;
            border: none !important;
            border-radius: 14px !important;
            padding: 14px 24px !important;
            font-size: 14px !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            transition: all 0.3s !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            width: 100% !important;
            margin-top: 10px !important;
            margin-bottom: 5px !important;
        }

        .dy-copy-all-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 22px rgba(255, 149, 0, 0.3) !important;
        }

        .dy-copy-all-btn.copied {
            background: linear-gradient(135deg, #10B981, #34D399) !important;
        }

        /* æç¤ºä¿¡æ¯æ ·å¼ */
        .dy-help-tip {
            background: linear-gradient(135deg, #FFF3CD, #FFEAA7) !important;
            border: 1px solid #FFD54F !important;
            border-radius: 14px !important;
            padding: 16px !important;
            margin-top: 12px !important;
            font-size: 13px !important;
            color: #856404 !important;
            line-height: 1.5 !important;
        }

        .dy-help-tip strong {
            color: #D35400 !important;
        }

        .dy-help-tip ol {
            margin: 8px 0 8px 20px !important;
            padding-left: 0 !important;
        }

        .dy-help-tip li {
            margin-bottom: 6px !important;
        }

        /* ç©ºçŠ¶æ€ */
        .dy-empty-state {
            text-align: center !important;
            padding: 50px 24px !important;
            color: var(--text-secondary-color) !important;
        }

        .dy-empty-state-icon {
            font-size: 60px !important;
            margin-bottom: 18px !important;
            opacity: 0.3 !important;
        }

        /* çŠ¶æ€æ  */
        .dy-status-bar {
            background: linear-gradient(to right, rgba(0,0,0,0.02) 0%, transparent 100%) !important;
            padding: 16px 28px !important;
            border-top: 1px solid rgba(0,0,0,0.06) !important;
            font-size: 11px !important;
            color: var(--text-secondary-color) !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        @media (max-width: 768px) {
            #dy-extractor-panel {
                width: 92vw !important;
                max-height: 85vh !important;
            }
        }
    `);

    // --- å·¥å…·å‡½æ•° ---
    function cleanNickname(rawName) {
        if (!rawName) return '';
        return rawName
            .replace(/[çš„\-_\s]*(æŠ–éŸ³|douyin|Dy|DY|TikTok)[\s\-_]*$/i, '')
            .replace(/^[\s\-_\|]+|[\s\-_\|]+$/g, '')
            .trim();
    }

    function applyTheme() {
        const theme = userData.isOwnPage ? CONFIG.themes.self : CONFIG.themes.others;
        document.documentElement.style.setProperty('--primary-color', theme.primary);
        document.documentElement.style.setProperty('--secondary-color', theme.secondary);
        document.documentElement.style.setProperty('--accent-color', theme.accent);
        document.documentElement.style.setProperty('--background-color', theme.background);
        document.documentElement.style.setProperty('--card-bg-color', theme.cardBg);
        document.documentElement.style.setProperty('--text-primary-color', theme.textPrimary);
        document.documentElement.style.setProperty('--text-secondary-color', theme.textSecondary);
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šé¡µé¢ç±»å‹æ£€æµ‹ ---
    function detectPageType() {
        const url = window.location.href;
        const title = document.title.toLowerCase();

        // ç²¾ç¡®åˆ¤æ–­è‡ªå·±é¡µé¢
        const isSelfPage =
            url.includes('/user/self') ||
            url.includes('showTab=post') ||
            title.includes('æˆ‘çš„ä¸»é¡µ') ||
            title.includes('ä¸ªäººä¸»é¡µ');

        // åˆ¤æ–­ä»–äººé¡µé¢
        const isOthersPage = url.includes('/user/') && !url.includes('/user/self');

        // è®¾ç½®é¡µé¢ç±»å‹
        if (isSelfPage) {
            userData.isOwnPage = true;
            console.log('[æå–å™¨] æ£€æµ‹åˆ°: è‡ªå·±é¡µé¢');
        } else if (isOthersPage) {
            userData.isOwnPage = false;
            console.log('[æå–å™¨] æ£€æµ‹åˆ°: ä»–äººé¡µé¢');
        } else {
            // é»˜è®¤æ ¹æ®æ•°æ®åˆ¤æ–­
            userData.isOwnPage = userData.secUid && userData.secUid.length > 20;
        }

        return userData.isOwnPage;
    }

    // --- æ–°å¢ï¼šå¢å¼ºçš„è‡ªåŠ¨è§¦å‘å‡½æ•°ï¼ˆæ¨¡æ‹Ÿç‚¹å‡»ï¼‰ ---
    function enhancedAutoTrigger() {
        if (autoClickAttempted || userData.secUid) {
            console.log('[æå–å™¨] å·²å°è¯•è¿‡æˆ–å·²æœ‰æ•°æ®ï¼Œè·³è¿‡è‡ªåŠ¨è§¦å‘');
            return;
        }
        console.log('[æå–å™¨] å¼€å§‹å¢å¼ºç‰ˆè‡ªåŠ¨è·å–...');
        autoClickAttempted = true;

        // ç­–ç•¥ï¼šä¼˜å…ˆå¯»æ‰¾å¹¶ç‚¹å‡»"å…³æ³¨åˆ—è¡¨"ï¼Œå…¶æ¬¡æ˜¯"å…³æ³¨"æŒ‰é’®
        const selectors = [
            '[data-e2e="user-follow-list"]', // å…³æ³¨åˆ—è¡¨æŒ‰é’®
            '[data-e2e="user-follow"]',      // å…³æ³¨æŒ‰é’®
            '.dy-account-follow',            // å…³æ³¨æŒ‰é’®çš„ç±»
            'button:contains("å…³æ³¨")',        // åŒ…å«"å…³æ³¨"æ–‡å­—çš„æŒ‰é’®
            'div:contains("å…³æ³¨åˆ—è¡¨")'        // åŒ…å«"å…³æ³¨åˆ—è¡¨"æ–‡å­—çš„div
        ];

        let found = false;
        for (let selector of selectors) {
            const elements = document.querySelectorAll(selector);
            if (elements.length > 0) {
                console.log(`[æå–å™¨] æ‰¾åˆ°å…ƒç´  ${selector}ï¼Œå°è¯•è§¦å‘`);
                elements[0].click();
                found = true;
                // ç‚¹å‡»åçŸ­æš‚å»¶è¿Ÿï¼Œç»™ç½‘ç»œè¯·æ±‚ç•™å‡ºæ—¶é—´
                setTimeout(() => {
                    console.log('[æå–å™¨] è‡ªåŠ¨è§¦å‘ç‚¹å‡»å®Œæˆ');
                }, 800);
                break;
            }
        }

        if (!found) {
            console.log('[æå–å™¨] æœªæ‰¾åˆ°åˆé€‚çš„è§¦å‘å…ƒç´ ï¼Œå°†åœ¨é¢æ¿æ˜¾ç¤ºæ‰‹åŠ¨æŒ‡å¼•');
        }
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šç½‘ç»œè¯·æ±‚ç›‘å¬ ---
    function setupNetworkListener() {
        const originalOpen = XMLHttpRequest.prototype.open;
        const originalSend = XMLHttpRequest.prototype.send;
        const originalFetch = window.fetch;

        XMLHttpRequest.prototype.open = function(method, url) {
            this._requestUrl = url;
            this._requestMethod = method;
            return originalOpen.apply(this, arguments);
        };

        XMLHttpRequest.prototype.send = function(body) {
            const requestUrl = this._requestUrl;
            if (!requestUrl) return originalSend.apply(this, arguments);

            // 1. ç›‘å¬ä»–äººä½œå“åˆ—è¡¨è¯·æ±‚ - è·å–åšä¸»UID (author_user_id)
            if (requestUrl.includes('/web/aweme/post')) {
                const originalOnReadyStateChange = this.onreadystatechange;
                this.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        try {
                            const response = JSON.parse(this.responseText);
                            if (response && response.aweme_list && response.aweme_list.length > 0) {
                                const awemeItem = response.aweme_list[0];

                                // åªåœ¨ä»–äººé¡µé¢æ—¶æ›´æ–°åšä¸»ä¿¡æ¯
                                if (!userData.isOwnPage) {
                                    // å…³é”®ä¿®å¤ï¼šä»author_user_idå­—æ®µè·å–åšä¸»UID
                                    if (awemeItem.author_user_id) {
                                        userData.uid = awemeItem.author_user_id.toString();
                                        console.log('[æå–å™¨] æå–åˆ°åšä¸»UID (author_user_id):', userData.uid);
                                    }

                                    // ä»authorå¯¹è±¡è·å–å…¶ä»–ä¿¡æ¯
                                    if (awemeItem.author) {
                                        userData.nickname = cleanNickname(awemeItem.author.nickname || '');
                                        userData.secUid = awemeItem.author.sec_uid || awemeItem.author.sec_user_id || '';
                                    }

                                    userData.lastUpdated = new Date().toLocaleTimeString();
                                    updateDisplay();
                                }
                            }
                        } catch (e) {
                            console.error('[æå–å™¨] è§£æä½œå“åˆ—è¡¨å¤±è´¥:', e);
                        }
                    }
                    if (originalOnReadyStateChange) {
                        return originalOnReadyStateChange.apply(this, arguments);
                    }
                };
            }

            // 2. ç›‘å¬å…³æ³¨åˆ—è¡¨è¯·æ±‚ - è·å–è‡ªå·±çš„sec_user_idï¼ˆå¼ºåŒ–å“åº”è§£æï¼‰
            if (requestUrl.includes('/web/user/following/list') || requestUrl.includes('/aweme/v1/web/user/following/list')) {
                console.log('[æå–å™¨] æ£€æµ‹åˆ°å…³æ³¨åˆ—è¡¨è¯·æ±‚:', requestUrl);

                // ä»URLæå–sec_user_id
                try {
                    const urlObj = new URL(requestUrl, window.location.origin);
                    const secUidFromUrl = urlObj.searchParams.get('sec_user_id');
                    if (secUidFromUrl && secUidFromUrl.length > 10) {
                        userData.secUid = secUidFromUrl;
                        userData.isOwnPage = true;
                        console.log('[æå–å™¨] ä»URLå‚æ•°æå–åˆ°SecUserID:', userData.secUid);
                    }
                } catch (e) { console.warn('[æå–å™¨] URLè§£æå¤±è´¥:', e); }

                // æ–°å¢å…³é”®é€»è¾‘ï¼šç›‘å¬å“åº”ï¼Œä»JSONæ•°æ®ä¸­æå–
                const originalOnReadyStateChange = this.onreadystatechange;
                this.onreadystatechange = function() {
                    if (this.readyState === 4 && this.status === 200) {
                        try {
                            const response = JSON.parse(this.responseText);
                            // å°è¯•ä»å“åº”æ•°æ®çš„å¸¸è§è·¯å¾„ä¸­æŸ¥æ‰¾ sec_user_id
                            let extractedSecUid = '';
                            if (response?.data?.user?.sec_uid) {
                                extractedSecUid = response.data.user.sec_uid;
                            } else if (response?.followings && response.followings[0]?.sec_uid) {
                                extractedSecUid = response.followings[0].sec_uid;
                            } else if (response?.sec_user_id) {
                                extractedSecUid = response.sec_user_id;
                            }

                            if (extractedSecUid && extractedSecUid.length > 10) {
                                userData.secUid = extractedSecUid;
                                userData.isOwnPage = true;
                                userData.lastUpdated = new Date().toLocaleTimeString() + ' (è‡ªåŠ¨è·å–)';
                                console.log('[æå–å™¨] ä»å“åº”JSONæå–åˆ°SecUserID:', userData.secUid);
                                updateDisplay(); // ç«‹å³æ›´æ–°é¢æ¿æ˜¾ç¤º
                                // å‘é€æˆåŠŸé€šçŸ¥
                                if (typeof GM_notification !== 'undefined') {
                                    GM_notification({
                                        text: `SecUserID è·å–æˆåŠŸï¼`,
                                        title: 'æŠ–éŸ³ä¿¡æ¯æå–å™¨',
                                        timeout: 3000
                                    });
                                }
                            }
                        } catch (parseError) {
                            console.warn('[æå–å™¨] è§£æå…³æ³¨åˆ—è¡¨å“åº”å¤±è´¥:', parseError);
                        }
                    }
                    if (originalOnReadyStateChange) {
                        return originalOnReadyStateChange.apply(this, arguments);
                    }
                };
            }

            return originalSend.apply(this, arguments);
        };

        // ç›‘å¬Fetchè¯·æ±‚
        window.fetch = function(input, init) {
            const requestUrl = typeof input === 'string' ? input : input.url;
            if (!requestUrl) return originalFetch.apply(this, arguments);

            // ç›‘å¬å…³æ³¨åˆ—è¡¨è¯·æ±‚
            if (requestUrl.includes('/web/user/following/list') || requestUrl.includes('/aweme/v1/web/user/following/list')) {
                console.log('[æå–å™¨] Fetchæ£€æµ‹åˆ°å…³æ³¨åˆ—è¡¨è¯·æ±‚');

                try {
                    const urlObj = new URL(requestUrl, window.location.origin);
                    const secUidFromUrl = urlObj.searchParams.get('sec_user_id');

                    if (secUidFromUrl) {
                        userData.secUid = secUidFromUrl;
                        userData.isOwnPage = true;
                        userData.lastUpdated = new Date().toLocaleTimeString();
                        console.log('[æå–å™¨] Fetchæå–åˆ°SecUserID:', userData.secUid);
                        updateDisplay();
                    }
                } catch (e) {
                    console.error('[æå–å™¨] Fetch URLè§£æå¤±è´¥:', e);
                }
            }

            return originalFetch.apply(this, arguments);
        };
    }

    // --- ç•Œé¢åˆ›å»º ---
    function createTriggerButton() {
        const existingBtn = document.getElementById('dy-extractor-trigger');
        if (existingBtn) existingBtn.remove();

        const btn = document.createElement('button');
        btn.id = 'dy-extractor-trigger';
        btn.innerHTML = userData.isOwnPage ? 'ğŸ‘¤' : 'ğŸ“Š';
        btn.title = userData.isOwnPage ? 'æˆ‘çš„ä¿¡æ¯' : 'åšä¸»ä¿¡æ¯';

        document.body.appendChild(btn);
        btn.addEventListener('click', showPanel);
        return btn;
    }

    function createOverlay() {
        const overlay = document.createElement('div');
        overlay.id = 'dy-extractor-overlay';
        overlay.addEventListener('click', hidePanel);
        document.body.appendChild(overlay);
        return overlay;
    }

    function createPanel() {
        const panel = document.createElement('div');
        panel.id = 'dy-extractor-panel';
        document.body.appendChild(panel);
        return panel;
    }

    // --- é¢æ¿æ˜¾ç¤º/éšè— ---
    function showPanel() {
        let panel = document.getElementById('dy-extractor-panel');
        let overlay = document.getElementById('dy-extractor-overlay');

        if (!panel) panel = createPanel();
        if (!overlay) overlay = createOverlay();

        updatePanelContent();

        setTimeout(() => {
            panel.classList.add('show');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }, 10);
    }

    function hidePanel() {
        const panel = document.getElementById('dy-extractor-panel');
        const overlay = document.getElementById('dy-extractor-overlay');

        if (panel) panel.classList.remove('show');
        if (overlay) overlay.classList.remove('show');
        document.body.style.overflow = '';
    }

    // --- ä¸€é”®å¤åˆ¶æ‰€æœ‰ä¿¡æ¯ ---
    function copyAllInfo() {
        let exportText = '';

        if (userData.isOwnPage) {
            // è‡ªå·±é¡µé¢çš„ä¸€é”®å¤åˆ¶
            exportText = `=== æˆ‘çš„æŠ–éŸ³ä¿¡æ¯ ===\n`;
            exportText += `SecUserID: ${userData.secUid || 'æœªè·å–'}\n`;

            if (userData.cookies) {
                exportText += `\n=== Cookieä¿¡æ¯ ===\n`;
                exportText += `${userData.cookies}\n`;
            }

            exportText += `\næå–æ—¶é—´: ${new Date().toLocaleString()}`;
        } else {
            // ä»–äººé¡µé¢çš„ä¸€é”®å¤åˆ¶
            exportText = `=== åšä¸»ä¿¡æ¯ ===\n`;
            exportText += `åšä¸»åå­—: ${userData.nickname || 'æœªè·å–'}\n`;
            exportText += `åšä¸»SecUID: ${userData.secUid || 'æœªè·å–'}\n`;
            exportText += `åšä¸»UID (author_user_id): ${userData.uid || 'æœªè·å–'}\n`;

            exportText += `\næå–æ—¶é—´: ${new Date().toLocaleString()}`;
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        GM_setClipboard(exportText, 'text');

        // æ˜¾ç¤ºé€šçŸ¥
        if (typeof GM_notification !== 'undefined') {
            GM_notification({
                text: 'æ‰€æœ‰ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
                title: 'æŠ–éŸ³ä¿¡æ¯æå–å™¨',
                timeout: 2000
            });
        }

        // æŒ‰é’®åé¦ˆæ•ˆæœ
        const copyAllBtn = document.querySelector('.dy-copy-all-btn');
        if (copyAllBtn) {
            const originalText = copyAllBtn.innerHTML;
            copyAllBtn.innerHTML = 'âœ… å¤åˆ¶æˆåŠŸï¼';
            copyAllBtn.classList.add('copied');

            setTimeout(() => {
                copyAllBtn.innerHTML = originalText;
                copyAllBtn.classList.remove('copied');
            }, 2000);
        }

        console.log('[æå–å™¨] å·²å¤åˆ¶æ‰€æœ‰ä¿¡æ¯åˆ°å‰ªè´´æ¿');
    }

    // --- æ›´æ–°é¢æ¿å†…å®¹ (ä¸¥æ ¼åˆ†ç¦»çš„ç•Œé¢) ---
    function updatePanelContent() {
        detectPageType();
        applyTheme();

        const panel = document.getElementById('dy-extractor-panel');
        if (!panel) return;

        const pageType = userData.isOwnPage ? 'è‡ªå·±é¡µé¢' : 'ä»–äººé¡µé¢';
        const title = userData.isOwnPage ? 'æˆ‘çš„æŠ–éŸ³ä¿¡æ¯' : 'åšä¸»ä¿¡æ¯æå–';
        const emoji = userData.isOwnPage ? 'ğŸ‘¤' : 'ğŸ‘¥';

        // æ›´æ–°æ‚¬æµ®æŒ‰é’®å›¾æ ‡
        const btn = document.getElementById('dy-extractor-trigger');
        if (btn) {
            btn.innerHTML = userData.isOwnPage ? 'ğŸ‘¤' : 'ğŸ“Š';
            btn.title = userData.isOwnPage ? 'æˆ‘çš„ä¿¡æ¯' : 'åšä¸»ä¿¡æ¯';
        }

        // æ ¹æ®é¡µé¢ç±»å‹ç”Ÿæˆä¸åŒçš„å†…å®¹
        let contentHtml = '';

        if (userData.isOwnPage) {
            // è‡ªå·±é¡µé¢å†…å®¹
            userData.cookies = document.cookie;
            const hasCookies = userData.cookies && userData.cookies.length > 0;
            const hasSecUid = userData.secUid && userData.secUid.length > 10;

            contentHtml = `
                <div class="dy-info-card">
                    <div class="dy-info-label">
                        <span class="dy-info-label-icon">ğŸ‘¤</span>
                        <span>æˆ‘çš„ SecUserID</span>
                        ${hasSecUid ? '<span style="color:var(--accent-color);font-size:11px;">âœ“ å·²è·å–</span>' : ''}
                    </div>
                    <div class="dy-info-value-wrapper">
                        <div class="dy-info-value">
                            ${userData.secUid || 'è‡ªåŠ¨è·å–ä¸­...'}
                        </div>
                        <button class="dy-copy-btn" data-text="${userData.secUid || ''}">
                            <span>ğŸ“‹ å¤åˆ¶</span>
                        </button>
                    </div>
                </div>

                <div class="dy-info-card">
                    <div class="dy-info-label">
                        <span class="dy-info-label-icon">ğŸª</span>
                        <span>Cookie ä¿¡æ¯</span>
                    </div>
                    <div class="dy-info-value-wrapper">
                        <div class="dy-info-value" style="font-size: 12px; max-height: 180px;">
                            ${hasCookies ? userData.cookies.replace(/;/g, ';\n') : 'æœªæ£€æµ‹åˆ°Cookie'}
                        </div>
                        ${hasCookies ? `
                            <button class="dy-copy-btn" data-text="${userData.cookies}">
                                <span>ğŸ“‹ å¤åˆ¶</span>
                            </button>
                        ` : ''}
                    </div>
                </div>

                <!-- æç¤ºä¿¡æ¯ï¼šå½“SecUserIDæœªè·å–åˆ°æ—¶æ˜¾ç¤º -->
                <div class="dy-help-tip">
                    <strong>ğŸ¤– è‡ªåŠ¨è·å–çŠ¶æ€</strong><br>
                    è„šæœ¬å·²å°è¯•è‡ªåŠ¨è·å–æ‚¨çš„SecUserIDã€‚
                    <span style="color:var(--accent-color);">
                        ${userData.secUid ? 'âœ… è·å–æˆåŠŸï¼' : 'ğŸ”„ æ­£åœ¨å°è¯•...'}
                    </span>
                    <br><br>
                    <strong>ğŸ“ æ‰‹åŠ¨è·å–æŒ‡å¼•ï¼ˆå¦‚è‡ªåŠ¨è·å–å¤±è´¥ï¼‰ï¼š</strong>
                    <ol>
                        <li>ç‚¹å‡»é¡µé¢ä¸Šçš„ <strong>"å…³æ³¨"</strong> æˆ– <strong>"å…³æ³¨åˆ—è¡¨"</strong> æŒ‰é’®ã€‚</li>
                        <li>ç­‰å¾…åˆ—è¡¨åŠ è½½ï¼ˆçº¦1-2ç§’ï¼‰ã€‚</li>
                        <li>å…³é—­åˆ—è¡¨ï¼Œè¿”å›æ­¤é¢æ¿æŸ¥çœ‹ç»“æœã€‚</li>
                    </ol>
                    æ­¤æ“ä½œæ˜¯å®‰å…¨çš„ï¼Œä»…ç”¨äºè§¦å‘æŠ–éŸ³é¡µé¢åŠ è½½æ‚¨çš„èº«ä»½ä¿¡æ¯ã€‚
                </div>

                <button class="dy-copy-all-btn">
                    ğŸ“‹ ä¸€é”®å¤åˆ¶æˆ‘çš„æ‰€æœ‰ä¿¡æ¯
                </button>
            `;
        } else {
            // ä»–äººé¡µé¢å†…å®¹ - é¡ºåºè°ƒæ•´ï¼šåšä¸»åå­— -> åšä¸»UID -> åšä¸»SecUID
            const hasData = userData.nickname || userData.uid || userData.secUid;

            if (!hasData) {
                contentHtml = `
                    <div class="dy-empty-state">
                        <div class="dy-empty-state-icon">ğŸ”</div>
                        <div class="dy-empty-state-text">
                            <p>æ­£åœ¨ç­‰å¾…åšä¸»ä¿¡æ¯...</p>
                            <p style="font-size:13px;margin-top:15px;color:var(--text-secondary-color);">
                                è¯·å‘ä¸‹æ»šåŠ¨åšä¸»ä½œå“åˆ—è¡¨ä»¥è§¦å‘æ•°æ®æå–
                            </p>
                        </div>
                    </div>

                    <button class="dy-copy-all-btn">
                        ğŸ“‹ ä¸€é”®å¤åˆ¶æ‰€æœ‰ä¿¡æ¯
                    </button>
                `;
            } else {
                contentHtml = `
                    <div class="dy-info-card">
                        <div class="dy-info-label">
                            <span class="dy-info-label-icon">ğŸ‘¤</span>
                            <span>åšä¸»åå­—</span>
                        </div>
                        <div class="dy-info-value-wrapper">
                            <div class="dy-info-value">${userData.nickname || 'æœªè·å–'}</div>
                            <button class="dy-copy-btn" data-text="${userData.nickname || ''}">
                                <span>ğŸ“‹ å¤åˆ¶</span>
                            </button>
                        </div>
                    </div>

                    <div class="dy-info-card">
                        <div class="dy-info-label">
                            <span class="dy-info-label-icon">ğŸ”¢</span>
                            <span>åšä¸» UID (author_user_id)</span>
                        </div>
                        <div class="dy-info-value-wrapper">
                            <div class="dy-info-value">${userData.uid || 'æœªè·å–'}</div>
                            <button class="dy-copy-btn" data-text="${userData.uid || ''}">
                                <span>ğŸ“‹ å¤åˆ¶</span>
                            </button>
                        </div>
                    </div>

                    <div class="dy-info-card">
                        <div class="dy-info-label">
                            <span class="dy-info-label-icon">ğŸ†”</span>
                            <span>åšä¸» SecUID</span>
                        </div>
                        <div class="dy-info-value-wrapper">
                            <div class="dy-info-value">${userData.secUid || 'æœªè·å–'}</div>
                            <button class="dy-copy-btn" data-text="${userData.secUid || ''}">
                                <span>ğŸ“‹ å¤åˆ¶</span>
                            </button>
                        </div>
                    </div>

                    <button class="dy-copy-all-btn">
                        ğŸ“‹ ä¸€é”®å¤åˆ¶åšä¸»æ‰€æœ‰ä¿¡æ¯
                    </button>
                `;
            }
        }

        panel.innerHTML = `
            <div class="dy-extractor-header">
                <button class="dy-extractor-close" title="å…³é—­">Ã—</button>
                <h2 class="dy-extractor-title">
                    <span>${emoji} ${title}</span>
                    <span class="dy-page-type-badge">${pageType}</span>
                </h2>
                <p class="dy-extractor-subtitle">æœ€åæ›´æ–°: ${userData.lastUpdated || 'ç­‰å¾…æ•°æ®...'}</p>
            </div>
            <div class="dy-extractor-content">
                ${contentHtml}
            </div>
            <div class="dy-status-bar">
                <span>æŠ–éŸ³ä¿¡æ¯æå–å™¨ v10.1</span>
                <span>å¢å¼ºè‡ªåŠ¨è·å–ç‰ˆ</span>
            </div>
        `;

        // ç»‘å®šäº‹ä»¶
        panel.querySelector('.dy-extractor-close').addEventListener('click', hidePanel);
        panel.querySelector('.dy-copy-all-btn').addEventListener('click', copyAllInfo);

        // ç»‘å®šå•ä¸ªå¤åˆ¶æŒ‰é’®
        panel.querySelectorAll('.dy-copy-btn').forEach(btn => {
            btn.addEventListener('click', handleCopy);
        });
    }

    // --- å•ä¸ªå¤åˆ¶åŠŸèƒ½ ---
    async function handleCopy(event) {
        const button = event.currentTarget;
        const text = button.getAttribute('data-text');

        if (!text) {
            button.innerHTML = '<span>âŒ æ— å†…å®¹</span>';
            setTimeout(() => button.innerHTML = '<span>ğŸ“‹ å¤åˆ¶</span>', 2000);
            return;
        }

        try {
            await navigator.clipboard.writeText(text);
            GM_setClipboard(text, 'text');

            button.innerHTML = '<span>âœ… å·²å¤åˆ¶</span>';
            button.classList.add('copied');

            setTimeout(() => {
                button.innerHTML = '<span>ğŸ“‹ å¤åˆ¶</span>';
                button.classList.remove('copied');
            }, 2000);

        } catch (err) {
            button.innerHTML = '<span>âŒ å¤±è´¥</span>';
            setTimeout(() => button.innerHTML = '<span>ğŸ“‹ å¤åˆ¶</span>', 2000);
        }
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        console.log('[æŠ–éŸ³ä¿¡æ¯æå–å™¨ v10.1] å¯åŠ¨ - å¢å¼ºè‡ªåŠ¨è·å–ç‰ˆ');

        // å…ˆæ£€æµ‹é¡µé¢ç±»å‹
        detectPageType();

        // åº”ç”¨ä¸»é¢˜
        applyTheme();

        // è®¾ç½®ç½‘ç»œç›‘å¬
        setupNetworkListener();

        // åˆ›å»ºç•Œé¢å…ƒç´ 
        createTriggerButton();
        createOverlay();

        // å¦‚æœæ˜¯è‡ªå·±é¡µé¢ï¼Œä½¿ç”¨å¢å¼ºç‰ˆè‡ªåŠ¨è·å–
        if (userData.isOwnPage) {
            console.log('[æå–å™¨] æ£€æµ‹åˆ°è‡ªå·±é¡µé¢ï¼Œå¯åŠ¨å¢å¼ºç‰ˆè‡ªåŠ¨è·å–...');
            // ç»™äºˆé¡µé¢ä¸€ç‚¹åŠ è½½æ—¶é—´
            setTimeout(() => {
                enhancedAutoTrigger();
            }, 2500);
        }

        // åˆå§‹æå–åŸºç¡€ä¿¡æ¯
        setTimeout(() => {
            // æå–æ˜µç§°ï¼ˆå¦‚æœæ˜¯ä»–äººé¡µé¢ï¼‰
            const titleEl = document.querySelector('[data-e2e="user-title"]');
            if (titleEl && !userData.isOwnPage) {
                userData.nickname = cleanNickname(titleEl.textContent.trim());
            }

            // è·å–Cookieï¼ˆå¦‚æœæ˜¯è‡ªå·±é¡µé¢ï¼‰
            if (userData.isOwnPage) {
                userData.cookies = document.cookie;
            }

            userData.lastUpdated = new Date().toLocaleTimeString();
            updateDisplay();
        }, 1000);
    }

    // --- æ›´æ–°æ˜¾ç¤º ---
    function updateDisplay() {
        updatePanelContent();
    }

    // --- å¯åŠ¨è„šæœ¬ ---
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();

// =========================
//  MIT License æ”¾ç½®åŒºï¼ˆè§„èŒƒä½ç½®ï¼šè„šæœ¬æœ«å°¾ï¼‰
// =========================

/*
MIT License

Copyright (c) 2025 kevencs

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/
